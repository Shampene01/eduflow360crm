rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {

    // ================================
    // AUTH & ROLE HELPERS
    // ================================
    function isAuthenticated() {
      return request.auth != null;
    }

    function roleCode() {
      return request.auth.token.roleCode != null ? request.auth.token.roleCode : 0;
    }

    function platformRole() {
      return request.auth.token.platformRole != null ? request.auth.token.platformRole : "none";
    }

    function providerIdClaim() {
      return request.auth.token.providerId != null ? request.auth.token.providerId : "";
    }

    function hasValidClaims() {
      return isAuthenticated() && request.auth.token.roleCode != null;
    }

    function isSuperAdmin() {
      return hasValidClaims() && roleCode() == 4;
    }

    function isAdmin() {
      return hasValidClaims() && roleCode() >= 3;
    }

    function isProvider() {
      return hasValidClaims() &&
        roleCode() == 2 &&
        platformRole() == "provider";
    }

    function isProviderOwner(providerId) {
      return isProvider() && providerIdClaim() == providerId;
    }

    // ================================
    // PROFILE PHOTOS
    // ================================
    match /profile-photos/{userId}/{fileName} {
      allow read: if isAuthenticated();
      allow write, delete: if isAuthenticated() && request.auth.uid == userId;
    }

    // ================================
    // ID DOCUMENTS
    // ================================
    match /id-documents/{userId}/{fileName} {
      allow read: if isAdmin() || (isAuthenticated() && request.auth.uid == userId);
      allow write, delete: if isAuthenticated() && request.auth.uid == userId;
    }

    // ================================
    // PROVIDER DOCUMENTS
    // ================================
    // Path: provider-documents/{userIdOrProviderId}/{fileName}
    // During application, userId is used. After approval, providerId is used.
    match /provider-documents/{ownerId}/{fileName} {
      allow read: if isAdmin() || isProviderOwner(ownerId) || 
        (isAuthenticated() && request.auth.uid == ownerId);
      allow write: if isAdmin() || isProviderOwner(ownerId) || 
        (isAuthenticated() && request.auth.uid == ownerId);
      allow delete: if isAdmin() || isProviderOwner(ownerId);
    }

    // ================================
    // PROPERTY IMAGES (PUBLIC)
    // ================================
    match /property-images/{providerId}/{propertyId}/{fileName} {
      allow read: if true;
      allow write, delete: if isAdmin() || isProviderOwner(providerId);
    }

    // ================================
    // PROPERTY FILES (PRIVATE)
    // ================================
    // Cover images: properties/{providerId}/{fileName}
    match /properties/{providerId}/{fileName} {
      allow read: if isAdmin() || isProviderOwner(providerId);
      allow write, delete: if isAdmin() || isProviderOwner(providerId);
    }
    // Property-specific files: properties/{providerId}/{propertyId}/{allPaths}
    match /properties/{providerId}/{propertyId}/{allPaths=**} {
      allow read: if isAdmin() || isProviderOwner(providerId);
      allow write, delete: if isAdmin() || isProviderOwner(providerId);
    }

    // ================================
    // PROVIDER BRANDING
    // ================================
    match /providers/{providerId}/{assetType}/{fileName} {
      allow read: if true;
      allow write, delete: if isAdmin() || isProviderOwner(providerId);
    }

    // ================================
    // STUDENT DOCUMENTS (PROVIDER-SCOPED)
    // ================================
    match /student-documents/{providerId}/{studentId}/{fileName} {
      allow read, write: if isAdmin() || isProviderOwner(providerId);
      allow delete: if isAdmin();
    }

    // ================================
    // INVOICE ATTACHMENTS
    // ================================
    match /invoices/{providerId}/{invoiceId}/{fileName} {
      allow read, write: if isAdmin() || isProviderOwner(providerId);
      allow delete: if isAdmin();
    }

    // ================================
    // TICKET ATTACHMENTS
    // ================================
    match /tickets/{ticketId}/{fileName} {
      allow read, write: if isAuthenticated();
      allow delete: if isAdmin();
    }

    // ================================
    // PLATFORM RESOURCES
    // ================================
    match /platform-resources/{allPaths=**} {
      allow read: if isAuthenticated();
      allow write, delete: if isSuperAdmin();
    }

    // ================================
    // DEFAULT DENY
    // ================================
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}
