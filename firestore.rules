rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // =====================================================
    // AUTH & ROLE HELPERS (CLAIMS-BASED)
    // =====================================================

    function isAuthenticated() {
      return request.auth != null;
    }

    // Null-safe claim accessors
    function roleCode() {
      return request.auth.token.roleCode != null ? request.auth.token.roleCode : 0;
    }

    function platformRole() {
      return request.auth.token.platformRole != null ? request.auth.token.platformRole : "none";
    }

    function providerIdClaim() {
      return request.auth.token.providerId != null ? request.auth.token.providerId : "";
    }

    function hasValidClaims() {
      return isAuthenticated() && request.auth.token.roleCode != null;
    }

    function isSuperAdmin() {
      return hasValidClaims() && roleCode() == 4;
    }

    function isAdmin() {
      return hasValidClaims() && roleCode() >= 3;
    }

    function isProvider() {
      return hasValidClaims() && roleCode() == 2 && platformRole() == "provider";
    }

    // =====================================================
    // OWNERSHIP HELPERS
    // =====================================================

    function isProviderOwner(targetProviderId) {
      return isProvider() && providerIdClaim() == targetProviderId;
    }

    // Provider staff: roleCode 1 with matching providerId claim
    function isProviderStaff(targetProviderId) {
      return hasValidClaims() && roleCode() == 1 && providerIdClaim() == targetProviderId;
    }

    // Either provider owner OR their staff can access provider data
    function canAccessProvider(targetProviderId) {
      return isProviderOwner(targetProviderId) || isProviderStaff(targetProviderId) || isAdmin();
    }

    function isPropertyOwnerByPropertyId(propertyId) {
      return isProvider() &&
        exists(/databases/$(database)/documents/properties/$(propertyId)) &&
        get(/databases/$(database)/documents/properties/$(propertyId)).data.providerId == providerIdClaim();
    }

    // =====================================================
    // RBAC PERMISSION HELPERS (Layer 2)
    // =====================================================
    
    // Get staff document for current user
    function getStaffDoc(providerId) {
      return get(/databases/$(database)/documents/accommodationProviders/$(providerId)/staff/$(request.auth.uid)).data;
    }
    
    // Get providerRole from staff document
    function getProviderRole(providerId) {
      return getStaffDoc(providerId).providerRole;
    }
    
    // Get permissions array for a role from /system/rbac
    function getRolePermissions(providerRole) {
      return get(/databases/$(database)/documents/system/rbac).data.providerRoles[providerRole].permissions;
    }
    
    // Check if staff member has specific permission
    function staffHasPermission(providerId, permission) {
      let staffDoc = getStaffDoc(providerId);
      // Check if staff is active
      return staffDoc.status == 'active' &&
        permission in getRolePermissions(staffDoc.providerRole);
    }
    
    // Check if staff exists and is active
    function isActiveStaff(providerId) {
      return exists(/databases/$(database)/documents/accommodationProviders/$(providerId)/staff/$(request.auth.uid)) &&
        getStaffDoc(providerId).status == 'active';
    }
    
    // Main permission check: Platform admin OR Provider owner OR Staff with permission
    function canAccess(providerId, permission) {
      return isAdmin()
        || isProviderOwner(providerId)
        || (isProviderStaff(providerId) && isActiveStaff(providerId) && staffHasPermission(providerId, permission));
    }
    
    // Simplified check for read operations (most common)
    function canView(providerId, permission) {
      return canAccess(providerId, permission);
    }

    // =====================================================
    // 1. USERS
    // =====================================================
    match /users/{userId} {
      allow read: if isAdmin() || (isAuthenticated() && request.auth.uid == userId);

      allow create: if isAuthenticated() && request.auth.uid == userId;

      // Admin can update/delete anything
      allow update, delete: if isAdmin();

      // User can update own profile except sensitive fields
      allow update: if isAuthenticated() && request.auth.uid == userId &&
        !request.resource.data.diff(resource.data).affectedKeys()
          .hasAny(['role', 'roleCode', 'roles', 'platformRole', 'providerId', 'isActive']);
    }

    // =====================================================
    // 2. ADDRESSES
    // =====================================================
    match /addresses/{addressId} {
      allow read, create, update: if isAuthenticated();
      allow delete: if isAdmin();
    }

    // =====================================================
    // 2.5 SYSTEM CONFIGURATION (RBAC)
    // =====================================================
    match /system/{document} {
      // All authenticated staff can read role definitions (roleCode >= 1)
      allow read: if hasValidClaims() && roleCode() >= 1;
      // Only superAdmin can modify system config
      allow write: if isSuperAdmin();
    }

    // =====================================================
    // 3. ACCOMMODATION PROVIDERS
    // =====================================================
    match /accommodationProviders/{providerId} {
      // Super admins can do anything
      allow read, create, update, delete: if isSuperAdmin();

      // Provider owner or staff can read
      allow read: if canAccessProvider(providerId);

      // Allow authenticated users to read their own provider record (for checking provider status)
      // This supports new users before claims are set
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;

      // Provider can update non-approval fields only
      allow update: if isProviderOwner(providerId) &&
        !request.resource.data.diff(resource.data).affectedKeys()
          .hasAny([
            'approvalStatus', 'approvedBy', 'approvalTimestamp', 'rejectionReason',
            'nsfasAccredited', 'nsfasAccreditedSince', 'accreditationExpiry'
          ]);

      // Self-registration (always Pending, required fields)
      allow create: if isAuthenticated() &&
        request.resource.data.userId == request.auth.uid &&
        request.resource.data.approvalStatus == "Pending" &&
        request.resource.data.keys().hasAll(['userId', 'companyName', 'approvalStatus', 'createdAt']);

      // Admins can delete providers
      allow delete: if isAdmin();

      // -------------------------------
      // STAFF (SUBCOLLECTION - RBAC Layer 2)
      // -------------------------------
      match /staff/{staffId} {
        // Staff can read their own document
        allow read: if request.auth.uid == staffId;
        
        // Provider owner can read all staff
        allow read: if isProviderOwner(providerId);
        
        // Admin can read/write anything
        allow read, write: if isAdmin();
        
        // Only provider owner can manage staff (invite, edit roles, deactivate)
        allow create, update, delete: if isProviderOwner(providerId);
      }

      // -------------------------------
      // PROPERTIES (SUBCOLLECTION)
      // -------------------------------
      match /properties/{propertyId} {
        // Public listing (Active only)
        allow read: if resource.data.status == "Active";

        // Provider, staff & admin read
        allow read: if canAccessProvider(providerId);

        // Admin can do anything
        allow create, update, delete: if isAdmin();

        // Provider or staff can create
        allow create: if canAccessProvider(providerId);

        // Provider/staff can update non-status fields only
        allow update: if canAccessProvider(providerId) &&
          !request.resource.data.diff(resource.data).affectedKeys()
            .hasAny(['nsfasApproved', 'status']);

        // Provider can delete drafts only (staff cannot delete)
        allow delete: if isProviderOwner(providerId) && resource.data.status == "Draft";

        // ---------------------------
        // PROPERTY DOCUMENTS
        // ---------------------------
        match /documents/{docId} {
          allow read: if canAccessProvider(providerId);

          // Admin can do anything
          allow create, update, delete: if isAdmin();

          allow create: if canAccessProvider(providerId) &&
            request.resource.data.verified == false;

          // Provider/staff can update non-verification fields only
          allow update: if canAccessProvider(providerId) &&
            !request.resource.data.diff(resource.data).affectedKeys()
              .hasAny(['verified', 'verifiedAt', 'verifiedBy']);

          // Only provider owner can delete (not staff)
          allow delete: if isProviderOwner(providerId) && resource.data.verified == false;
        }

        // ---------------------------
        // PROPERTY IMAGES
        // ---------------------------
        match /images/{imageId} {
          allow read: if true;
          allow create, update, delete: if canAccessProvider(providerId);
        }

        // ---------------------------
        // ROOM CONFIGURATIONS
        // ---------------------------
        match /roomConfigurations/{configId} {
          allow read, create, update: if canAccessProvider(providerId);
          allow delete: if isProviderOwner(providerId) || isAdmin();
        }
      }
    }

    // =====================================================
    // 4. PROPERTIES (TOP-LEVEL)
    // =====================================================
    match /properties/{propertyId} {
      // Public read: active properties only
      allow read: if resource.data.status == "Active";

      // Owner/admin read
      allow read: if isPropertyOwnerByPropertyId(propertyId) || isAdmin();

      // Admin can do anything
      allow create, update, delete: if isAdmin();

      // Provider create (must match claim)
      allow create: if isProvider() &&
        request.resource.data.providerId == providerIdClaim();

      // Provider update non-status fields
      allow update: if isPropertyOwnerByPropertyId(propertyId) &&
        !request.resource.data.diff(resource.data).affectedKeys()
          .hasAny(['nsfasApproved', 'status']);

      // Provider delete drafts only
      allow delete: if isPropertyOwnerByPropertyId(propertyId) && resource.data.status == "Draft";
    }

    // =====================================================
    // 5. PROPERTY ROOMS
    // =====================================================
    match /propertyRooms/{roomId} {
      allow read: if isAdmin() || isPropertyOwnerByPropertyId(resource.data.propertyId);
      allow create: if isPropertyOwnerByPropertyId(request.resource.data.propertyId);
      allow update, delete: if isAdmin() || isPropertyOwnerByPropertyId(resource.data.propertyId);
    }

    // =====================================================
    // 6. PROPERTY BEDS
    // =====================================================
    match /propertyBeds/{bedId} {
      allow read: if isAdmin() || isPropertyOwnerByPropertyId(resource.data.propertyId);
      allow create: if isPropertyOwnerByPropertyId(request.resource.data.propertyId);
      allow update, delete: if isAdmin() || isPropertyOwnerByPropertyId(resource.data.propertyId);
    }

    // =====================================================
    // 7. STUDENTS
    // =====================================================
    match /students/{studentId} {
      // Provider, staff & admin access (staff with matching providerId)
      allow read, create, update: if isAdmin() || 
        (hasValidClaims() && roleCode() >= 1 && providerIdClaim() == resource.data.providerId);
      
      // For create, check the incoming data
      allow create: if isAdmin() || 
        (hasValidClaims() && roleCode() >= 1 && providerIdClaim() == request.resource.data.providerId);

      // Student self-read if linked
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;

      allow delete: if isAdmin();
    }

    // =====================================================
    // 8. STUDENT PROPERTY ASSIGNMENTS
    // =====================================================
    match /studentPropertyAssignments/{assignmentId} {
      // Allow read if admin
      allow read: if isAdmin();
      
      // Allow read if user can access the provider (for single doc reads)
      allow read: if canAccessProvider(resource.data.providerId);
      
      // Allow list queries that filter by providerId matching user's claim
      // This enables queries like: where("providerId", "==", userProviderId)
      allow read: if hasValidClaims() && roleCode() >= 1 && 
        resource.data.providerId == providerIdClaim();
      
      allow update: if isAdmin() || canAccessProvider(resource.data.providerId);
      allow create: if isAdmin() || canAccessProvider(request.resource.data.providerId);
      allow delete: if isAdmin();
    }

    // =====================================================
    // 9. PROVIDER CONTACT PERSONS
    // =====================================================
    match /providerContactPersons/{contactId} {
      allow read: if isAdmin() || canAccessProvider(resource.data.providerId);
      
      // Admin can create, or provider owner, or the user who created the provider (for new applications before claims are set)
      allow create: if isAdmin() || isProviderOwner(request.resource.data.providerId) ||
        (isAuthenticated() && 
         exists(/databases/$(database)/documents/accommodationProviders/$(request.resource.data.providerId)) &&
         get(/databases/$(database)/documents/accommodationProviders/$(request.resource.data.providerId)).data.userId == request.auth.uid);
      
      allow update: if isAdmin() || canAccessProvider(resource.data.providerId);
      allow delete: if isAdmin();
    }

    // =====================================================
    // 10. PROVIDER DOCUMENTS (TOP-LEVEL)
    // =====================================================
    match /providerDocuments/{docId} {
      allow read: if isAdmin() || canAccessProvider(resource.data.providerId);

      // Admin can create, or provider owner, or the user who created the provider (for new applications before claims are set)
      allow create: if isAdmin() || 
        (request.resource.data.verified == false &&
         (isProviderOwner(request.resource.data.providerId) ||
          (isAuthenticated() && 
           exists(/databases/$(database)/documents/accommodationProviders/$(request.resource.data.providerId)) &&
           get(/databases/$(database)/documents/accommodationProviders/$(request.resource.data.providerId)).data.userId == request.auth.uid)));

      // Provider can update non-verification fields only
      allow update: if isProviderOwner(resource.data.providerId) &&
        !request.resource.data.diff(resource.data).affectedKeys()
          .hasAny(['verified', 'verifiedAt', 'verifiedBy']);

      allow update, delete: if isAdmin();

      // Provider can delete only if not verified
      allow delete: if isProviderOwner(resource.data.providerId) && resource.data.verified == false;
    }

    // =====================================================
    // 11. INVOICES
    // =====================================================
    match /invoices/{invoiceId} {
      allow read: if isAdmin() || canAccessProvider(resource.data.providerId);
      allow create: if isAdmin() || canAccessProvider(request.resource.data.providerId);
      allow update: if isAdmin() || canAccessProvider(resource.data.providerId);
      allow delete: if isAdmin();
    }

    // =====================================================
    // 12. TICKETS
    // =====================================================
    match /tickets/{ticketId} {
      // Submitter, provider/staff (if ticket has providerId), or admin can read
      allow read: if isAdmin() || (isAuthenticated() && resource.data.submittedBy == request.auth.uid);
      allow read: if hasValidClaims() && roleCode() >= 1 && resource.data.providerId == providerIdClaim();

      // Submitter can create their own ticket
      allow create: if isAuthenticated() && request.resource.data.submittedBy == request.auth.uid;

      // Submitter can update their own ticket; admins can update any
      allow update: if isAdmin() || (isAuthenticated() && resource.data.submittedBy == request.auth.uid);

      allow delete: if isAdmin();

      match /updates/{updateId} {
        // Submitter or admin can read updates
        allow read: if isAdmin() || (isAuthenticated() &&
          exists(/databases/$(database)/documents/tickets/$(ticketId)) &&
          get(/databases/$(database)/documents/tickets/$(ticketId)).data.submittedBy == request.auth.uid);

        // Submitter can create updates to their own ticket; admins can create too
        allow create: if isAdmin() || (isAuthenticated() &&
          exists(/databases/$(database)/documents/tickets/$(ticketId)) &&
          get(/databases/$(database)/documents/tickets/$(ticketId)).data.submittedBy == request.auth.uid);

        // Admin can update/delete any update
        allow update, delete: if isAdmin();
        
        // Ticket submitter can update read status on updates (for marking as read)
        allow update: if isAuthenticated() &&
          exists(/databases/$(database)/documents/tickets/$(ticketId)) &&
          get(/databases/$(database)/documents/tickets/$(ticketId)).data.submittedBy == request.auth.uid &&
          request.resource.data.diff(resource.data).affectedKeys()
            .hasOnly(['status', 'readAt', 'readBy']);
      }
    }

    // =====================================================
    // 13. PLATFORM RESOURCES
    // =====================================================
    match /platformResources/{resourceId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isSuperAdmin();
    }

    // =====================================================
    // 14. PAYMENTS
    // =====================================================
    match /payments/{paymentId} {
      // Providers & staff can read payments for their provider
      allow read: if isAdmin() || canAccessProvider(resource.data.providerId);

      // Providers & staff can create payments
      allow create: if isAdmin() || canAccessProvider(request.resource.data.providerId);

      // Providers & staff can update payments
      allow update: if isAdmin() || canAccessProvider(resource.data.providerId);

      // Only admins can delete payments
      allow delete: if isAdmin();
    }

    // =====================================================
    // 15. TASKS (Provider Manager Tasks)
    // =====================================================
    match /tasks/{taskId} {
      // Providers & staff can read tasks
      allow read: if isAdmin() || canAccessProvider(resource.data.providerId);

      // Providers & staff can create tasks
      allow create: if isAdmin() || canAccessProvider(request.resource.data.providerId);

      // Providers & staff can update tasks
      allow update: if isAdmin() || canAccessProvider(resource.data.providerId);

      // Only admins can delete tasks
      allow delete: if isAdmin();
    }

    // =====================================================
    // 16. PROVIDER SUMMARIES (Aggregated data for dashboards)
    // =====================================================
    match /providerSummaries/{providerId} {
      // Providers & staff can read their provider's summary
      allow read: if isAdmin() || canAccessProvider(providerId);

      // Only Cloud Functions can write (no client writes)
      allow write: if false;
    }

    // =====================================================
    // 17. PENDING USERS (Staff Onboarding Queue)
    // =====================================================
    match /pendingUsers/{pendingUserId} {
      // Providers & staff can read pending users for their provider
      allow read: if isAdmin() || canAccessProvider(resource.data.providerId);

      // Providers can create pending users for their provider
      allow create: if isAdmin() || canAccessProvider(request.resource.data.providerId);

      // Only admins/system can update (Power Automate will use service account)
      allow update: if isAdmin();

      // Only admins can delete
      allow delete: if isAdmin();
    }
  }
}