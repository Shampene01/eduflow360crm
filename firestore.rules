rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================================================
    // HELPER FUNCTIONS
    // ============================================================================
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function hasRole(role) {
      return isAuthenticated() && 
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        role in get(/databases/$(database)/documents/users/$(request.auth.uid)).data.roles;
    }
    
    function isAdmin() {
      return hasRole('admin');
    }
    
    function isProvider() {
      return hasRole('provider');
    }
    
    function isProviderOwner(providerId) {
      return isAuthenticated() &&
        exists(/databases/$(database)/documents/accommodationProviders/$(providerId)) &&
        get(/databases/$(database)/documents/accommodationProviders/$(providerId)).data.userId == request.auth.uid;
    }
    
    // ============================================================================
    // USERS COLLECTION (Natural Persons)
    // ============================================================================
    
    match /users/{userId} {
      // Users can read their own document
      allow read: if isOwner(userId) || isAdmin();
      
      // Users can create their own document during registration
      allow create: if isOwner(userId);
      
      // Users can update their own document (except roles)
      allow update: if isOwner(userId) && 
        (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['roles'])) ||
        isAdmin();
      
      // Only admins can delete users
      allow delete: if isAdmin();
    }
    
    // ============================================================================
    // ADDRESSES COLLECTION
    // ============================================================================
    
    match /addresses/{addressId} {
      // Anyone authenticated can read addresses (needed for lookups)
      allow read: if isAuthenticated();
      
      // Authenticated users can create addresses
      allow create: if isAuthenticated();
      
      // Only the creator or admin can update/delete
      allow update, delete: if isAdmin();
    }
    
    // ============================================================================
    // ACCOMMODATION PROVIDERS COLLECTION
    // ============================================================================
    
    match /accommodationProviders/{providerId} {
      // Providers can read their own record, admins can read all
      allow read: if isProviderOwner(providerId) || isAdmin();
      
      // Authenticated users can create a provider application
      allow create: if isAuthenticated() && 
        request.resource.data.userId == request.auth.uid;
      
      // Provider owners can update their record (except approval fields)
      allow update: if (isProviderOwner(providerId) && 
        !request.resource.data.diff(resource.data).affectedKeys()
          .hasAny(['approvalStatus', 'approvalTimestamp', 'approvedBy', 'rejectionReason'])) ||
        isAdmin();
      
      // Only admins can delete
      allow delete: if isAdmin();
    }
    
    // ============================================================================
    // PROVIDER CONTACT PERSONS COLLECTION
    // ============================================================================
    
    match /providerContactPersons/{contactId} {
      // Provider owners and admins can read
      allow read: if isProviderOwner(resource.data.providerId) || isAdmin();
      
      // Provider owners can create contacts for their provider
      allow create: if isAuthenticated();
      
      // Provider owners can update their contacts
      allow update: if isProviderOwner(resource.data.providerId) || isAdmin();
      
      // Provider owners can delete their contacts
      allow delete: if isProviderOwner(resource.data.providerId) || isAdmin();
    }
    
    // ============================================================================
    // PROVIDER DOCUMENTS COLLECTION
    // ============================================================================
    
    match /providerDocuments/{documentId} {
      // Provider owners and admins can read
      allow read: if isAuthenticated();
      
      // Provider owners can upload documents
      allow create: if isAuthenticated();
      
      // Only admins can update (for verification)
      allow update: if isAdmin();
      
      // Provider owners can delete unverified documents
      allow delete: if (isProviderOwner(resource.data.providerId) && 
        resource.data.verified == false) || isAdmin();
    }
    
    // ============================================================================
    // PROPERTIES COLLECTION
    // ============================================================================
    
    match /properties/{propertyId} {
      // Provider owners and admins can read their properties
      // Public can read active properties
      allow read: if resource.data.status == 'Active' || 
        isProviderOwner(resource.data.providerId) || 
        isAdmin();
      
      // Provider owners can create properties
      allow create: if isAuthenticated();
      
      // Provider owners can update their properties
      allow update: if isProviderOwner(resource.data.providerId) || isAdmin();
      
      // Only admins can delete properties
      allow delete: if isAdmin();
    }
    
    // ============================================================================
    // ROOM CONFIGURATIONS COLLECTION
    // ============================================================================
    
    match /roomConfigurations/{configId} {
      allow read: if isAuthenticated();
      
      allow create: if isAuthenticated();
      
      allow update, delete: if isAdmin() ||
        (exists(/databases/$(database)/documents/properties/$(resource.data.propertyId)) &&
        isProviderOwner(get(/databases/$(database)/documents/properties/$(resource.data.propertyId)).data.providerId));
    }
    
    // ============================================================================
    // PROPERTY ROOMS COLLECTION
    // ============================================================================
    
    match /propertyRooms/{roomId} {
      allow read: if isAuthenticated();
      
      allow create, update, delete: if isAdmin() ||
        (exists(/databases/$(database)/documents/properties/$(resource.data.propertyId)) &&
        isProviderOwner(get(/databases/$(database)/documents/properties/$(resource.data.propertyId)).data.providerId));
    }
    
    // ============================================================================
    // PROPERTY BEDS COLLECTION
    // ============================================================================
    
    match /propertyBeds/{bedId} {
      allow read: if isAuthenticated();
      
      allow create, update, delete: if isAdmin() ||
        (exists(/databases/$(database)/documents/properties/$(resource.data.propertyId)) &&
        isProviderOwner(get(/databases/$(database)/documents/properties/$(resource.data.propertyId)).data.providerId));
    }
    
    // ============================================================================
    // PROPERTY DOCUMENTS COLLECTION
    // ============================================================================
    
    match /propertyDocuments/{documentId} {
      allow read: if isAuthenticated();
      
      allow create, update, delete: if isAdmin() ||
        (exists(/databases/$(database)/documents/properties/$(resource.data.propertyId)) &&
        isProviderOwner(get(/databases/$(database)/documents/properties/$(resource.data.propertyId)).data.providerId));
    }
    
    // ============================================================================
    // PROPERTY IMAGES COLLECTION
    // ============================================================================
    
    match /propertyImages/{imageId} {
      // Anyone can read property images
      allow read: if true;
      
      allow create, update, delete: if isAdmin() ||
        (exists(/databases/$(database)/documents/properties/$(resource.data.propertyId)) &&
        isProviderOwner(get(/databases/$(database)/documents/properties/$(resource.data.propertyId)).data.providerId));
    }
    
    // ============================================================================
    // STUDENTS COLLECTION
    // ============================================================================
    
    match /students/{studentId} {
      // Students can read their own record, providers and admins can read all
      allow read: if (resource.data.userId == request.auth.uid) || 
        isProvider() || 
        isAdmin();
      
      // Providers and admins can create students
      allow create: if isProvider() || isAdmin();
      
      // Providers and admins can update students
      allow update: if isProvider() || isAdmin();
      
      // Only admins can delete
      allow delete: if isAdmin();
    }
    
    // ============================================================================
    // STUDENT PROPERTY ASSIGNMENTS COLLECTION
    // ============================================================================
    
    match /studentPropertyAssignments/{assignmentId} {
      // Providers can read assignments for their properties
      allow read: if isAdmin() ||
        (exists(/databases/$(database)/documents/properties/$(resource.data.propertyId)) &&
        isProviderOwner(get(/databases/$(database)/documents/properties/$(resource.data.propertyId)).data.providerId));
      
      // Providers can create assignments for their properties
      allow create: if isAdmin() ||
        (exists(/databases/$(database)/documents/properties/$(request.resource.data.propertyId)) &&
        isProviderOwner(get(/databases/$(database)/documents/properties/$(request.resource.data.propertyId)).data.providerId));
      
      // Providers can update assignments for their properties
      allow update: if isAdmin() ||
        (exists(/databases/$(database)/documents/properties/$(resource.data.propertyId)) &&
        isProviderOwner(get(/databases/$(database)/documents/properties/$(resource.data.propertyId)).data.providerId));
      
      // Only admins can delete
      allow delete: if isAdmin();
    }
    
    // ============================================================================
    // LEGACY COLLECTIONS (for backward compatibility)
    // ============================================================================
    
    match /invoices/{invoiceId} {
      allow read: if isOwner(resource.data.providerId) || isAdmin();
      allow create: if isAuthenticated();
      allow update: if isOwner(resource.data.providerId) || isAdmin();
      allow delete: if isAdmin();
    }
    
    match /tickets/{ticketId} {
      allow read: if isOwner(resource.data.userId) || isAdmin();
      allow create: if isAuthenticated();
      allow update: if isOwner(resource.data.userId) || isAdmin();
      allow delete: if isAdmin();
    }
  }
}