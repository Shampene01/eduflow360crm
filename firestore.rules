rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================================================
    // HELPER FUNCTIONS
    // ============================================================================
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Checks if the current user owns a user document
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Checks if the current user has a specific role in /users/{uid}.roles[]
    function hasRole(role) {
      return isAuthenticated() &&
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        role in get(/databases/$(database)/documents/users/$(request.auth.uid)).data.roles;
    }
    
    function isAdmin() {
      return hasRole('admin');
    }
    
    function isProvider() {
      return hasRole('provider');
    }
    
    // Checks if the authenticated user owns the provider with this providerId
    function isProviderOwner(providerId) {
      return isAuthenticated() &&
        exists(/databases/$(database)/documents/accommodationProviders/$(providerId)) &&
        get(/databases/$(database)/documents/accommodationProviders/$(providerId)).data.userId == request.auth.uid;
    }

    // Convenience: check if user is provider or admin
    function isProviderOrAdmin() {
      return isProvider() || isAdmin();
    }

    // Given a propertyId, check whether the authenticated user owns the property
    function ownsProperty(propertyId) {
      return exists(/databases/$(database)/documents/properties/$(propertyId)) &&
        isProviderOwner(get(/databases/$(database)/documents/properties/$(propertyId)).data.providerId);
    }
    
    
    // ============================================================================
    // USERS COLLECTION (Natural Persons)
    // ============================================================================
    
    match /users/{userId} {
      // Users can read their own document, admins can read all
      allow read: if isOwner(userId) || isAdmin();
      
      // Users can create their own document during registration
      allow create: if isOwner(userId);
      
      // Users can update their own document (but not roles)
      allow update: if (isOwner(userId) &&
        !request.resource.data.diff(resource.data).affectedKeys().hasAny(['roles'])) ||
        isAdmin();
      
      // Only admins can delete users
      allow delete: if isAdmin();
    }
    
    
    // ============================================================================
    // ADDRESSES COLLECTION (shared for users, providers, properties)
    // ============================================================================
    
    match /addresses/{addressId} {
      // Authenticated users can read addresses (for lookups, display, etc.)
      allow read: if isAuthenticated();
      
      // Any authenticated user may create an address
      allow create: if isAuthenticated();
      
      // Only admins can update or delete addresses
      allow update, delete: if isAdmin();
    }
    
    
    // ============================================================================
    // ACCOMMODATION PROVIDERS COLLECTION
    // ============================================================================
    
    match /accommodationProviders/{providerId} {
      // Providers can read their own record, admins can read all
      allow read: if isProviderOwner(providerId) || isAdmin();
      
      // Authenticated users can create a provider application for themselves
      allow create: if isAuthenticated() &&
        request.resource.data.userId == request.auth.uid;
      
      // Provider owners can update their record (except approval fields),
      // admins can update anything.
      allow update: if
        (
          isProviderOwner(providerId) &&
          !request.resource.data.diff(resource.data).affectedKeys()
            .hasAny(['approvalStatus', 'approvalTimestamp', 'approvedBy', 'rejectionReason'])
        ) ||
        isAdmin();
      
      // Only admins can delete providers
      allow delete: if isAdmin();
    }
    
    
    // ============================================================================
    // PROVIDER CONTACT PERSONS COLLECTION
    // ============================================================================
    
    match /providerContactPersons/{contactId} {
      // Provider owners and admins can read
      allow read: if isProviderOwner(resource.data.providerId) || isAdmin();
      
      // Provider owners can create contacts for their provider
      allow create: if isProviderOwner(request.resource.data.providerId) || isAdmin();
      
      // Provider owners and admins can update/delete their contacts
      allow update, delete: if isProviderOwner(resource.data.providerId) || isAdmin();
    }
    
    
    // ============================================================================
    // PROVIDER DOCUMENTS COLLECTION (ID copy, COR14.3, bank letter, etc.)
    // ============================================================================
    
    match /providerDocuments/{documentId} {
      // Only the provider owner and admins can read provider documents
      allow read: if isProviderOwner(resource.data.providerId) || isAdmin();
      
      // Provider owners can upload documents for their provider
      allow create: if isProviderOwner(request.resource.data.providerId) || isAdmin();
      
      // Only admins can update documents (e.g. verification flags)
      allow update: if isAdmin();
      
      // Provider owners can delete their own unverified documents, admins can delete any
      allow delete: if (isProviderOwner(resource.data.providerId) && resource.data.verified == false) || isAdmin();
    }
    
    
    // ============================================================================
    // PROPERTIES COLLECTION
    // ============================================================================
    
    match /properties/{propertyId} {
      // Public can read active properties;
      // provider owners and admins can read their properties regardless of status.
      allow read: if resource.data.status == 'Active' ||
        ownsProperty(propertyId) ||
        isAdmin();
      
      // Provider owners can create properties linked to their providerId
      allow create: if isProviderOwner(request.resource.data.providerId) || isAdmin();
      
      // Provider owners and admins can update their properties
      allow update: if ownsProperty(propertyId) || isAdmin();
      
      // Only admins can delete properties
      allow delete: if isAdmin();
    }
    
    
    // ============================================================================
    // ROOM CONFIGURATIONS COLLECTION
    // ============================================================================
    
    match /roomConfigurations/{configId} {
      // Authenticated users can read room configurations (for app display)
      allow read: if isAuthenticated();
      
      // Provider owners can create configurations for their properties
      allow create: if ownsProperty(request.resource.data.propertyId) || isAdmin();
      
      // Provider owners/admins can update/delete their configurations
      allow update, delete: if ownsProperty(resource.data.propertyId) || isAdmin();
    }
    
    
    // ============================================================================
    // PROPERTY ROOMS COLLECTION
    // ============================================================================
    
    match /propertyRooms/{roomId} {
      // Authenticated users (e.g. for listing property details) can read
      allow read: if isAuthenticated();
      
      // Provider owners/admins can manage rooms for their properties
      allow create: if ownsProperty(request.resource.data.propertyId) || isAdmin();
      allow update, delete: if ownsProperty(resource.data.propertyId) || isAdmin();
    }
    
    
    // ============================================================================
    // PROPERTY BEDS COLLECTION
    // ============================================================================
    
    match /propertyBeds/{bedId} {
      // Authenticated users can read bed info if needed for the UI
      allow read: if isAuthenticated();
      
      // Provider owners/admins can manage beds
      allow create: if ownsProperty(request.resource.data.propertyId) || isAdmin();
      allow update, delete: if ownsProperty(resource.data.propertyId) || isAdmin();
    }
    
    
    // ============================================================================
    // PROPERTY DOCUMENTS COLLECTION (e.g. lease, fire certificate, etc.)
    // ============================================================================
    
    match /propertyDocuments/{documentId} {
      // Authenticated users can read property documents if the property is active;
      // provider owner & admins can read regardless of status.
      allow read: if isAdmin() ||
        (exists(/databases/$(database)/documents/properties/$(resource.data.propertyId)) &&
          (
            get(/databases/$(database)/documents/properties/$(resource.data.propertyId)).data.status == 'Active' ||
            ownsProperty(resource.data.propertyId)
          )
        );
      
      // Provider owners/admins can create/update/delete docs for their properties
      allow create: if ownsProperty(request.resource.data.propertyId) || isAdmin();
      allow update, delete: if ownsProperty(resource.data.propertyId) || isAdmin();
    }
    
    
    // ============================================================================
    // PROPERTY IMAGES COLLECTION
    // ============================================================================
    
    match /propertyImages/{imageId} {
      // Anyone can read property images (for public listings)
      allow read: if true;
      
      // Provider owners/admins can manage their property images
      allow create: if ownsProperty(request.resource.data.propertyId) || isAdmin();
      allow update, delete: if ownsProperty(resource.data.propertyId) || isAdmin();
    }
    
    
    // ============================================================================
    // STUDENTS COLLECTION
    // ============================================================================
    // NOTE: In this version we assume:
    // - Students are managed by providers and admins.
    // - There is no direct per-student user account link yet.
    // If you later add a "createdByUserId" or similar, we can tighten these rules.
    
    match /students/{studentId} {
      // Providers and admins can read students (for matching & assignment)
      allow read: if isProviderOrAdmin();
      
      // Providers and admins can create/update student records
      allow create, update: if isProviderOrAdmin();
      
      // Only admins can delete student records
      allow delete: if isAdmin();
    }
    
    
    // ============================================================================
    // STUDENT PROPERTY ASSIGNMENTS COLLECTION
    // ============================================================================
    
    match /studentPropertyAssignments/{assignmentId} {
      // Providers can read assignments for their properties; admins can read all
      allow read: if isAdmin() ||
        ownsProperty(resource.data.propertyId);
      
      // Providers can create assignments for their properties; admins can create any
      allow create: if isAdmin() ||
        ownsProperty(request.resource.data.propertyId);
      
      // Providers can update assignments for their properties; admins can update any
      allow update: if isAdmin() ||
        ownsProperty(resource.data.propertyId);
      
      // Only admins can delete assignments
      allow delete: if isAdmin();
    }
    
    
    // ============================================================================
    // LEGACY COLLECTIONS (for backward compatibility)
    // ============================================================================
    
    match /invoices/{invoiceId} {
      // Assuming invoice has field providerId linking to accommodationProviders document
      allow read, update: if isProviderOwner(resource.data.providerId) || isAdmin();
      allow create: if isAuthenticated();
      allow delete: if isAdmin();
    }
    
    match /tickets/{ticketId} {
      // Tickets tied to a natural user (not provider)
      allow read, update: if isOwner(resource.data.userId) || isAdmin();
      allow create: if isAuthenticated();
      allow delete: if isAdmin();
    }
  }
}
